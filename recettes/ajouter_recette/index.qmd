---
title: Ajouter une recette
image: index.png
order: 4
---

```{r}
#| echo: false
#| results: asis
#| message: false
#| warning: false

library(yaml)
library(jsonlite)

template <- yaml::read_yaml("../template.yaml")
schema <- template$`_schema`

cat(
  "<script>window.RECIPE_SCHEMA = ",
  jsonlite::toJSON(schema, auto_unbox = TRUE),
  ";</script>"
)
```

::: {.panel-tabset}

## Formulaire manuel

<div id="recipe-form-container"></div>

<div id="success-message" class="alert alert-success d-none"></div>
<div id="error-message" class="alert alert-danger d-none"></div>

## Importer depuis une URL

<!-- Section réservée pour import futur -->

:::

<script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  renderForm(window.RECIPE_SCHEMA, "recipe-form-container", []);
});

function renderForm(schema, containerId, path) {
  const container = document.getElementById(containerId);
  const form = document.createElement("form");
  form.classList.add("needs-validation");
  form.noValidate = true;

  form.appendChild(renderObject(schema, path));

  const btn = document.createElement("button");
  btn.type = "submit";
  btn.className = "btn btn-primary mt-3";
  btn.textContent = "Soumettre la recette";
  form.appendChild(btn);

  form.addEventListener("submit", handleSubmit);
  container.appendChild(form);
}

function renderObject(schema, path) {
  const wrapper = document.createElement("div");

  Object.entries(schema.properties).forEach(([key, prop]) => {
    const fieldPath = [...path, key];

    if (prop.type === "object") {
      wrapper.appendChild(renderSection(prop, key, fieldPath));
    } else if (prop.type === "array") {
      wrapper.appendChild(renderArray(prop, key, fieldPath));
    } else {
      wrapper.appendChild(renderPrimitive(prop, key, fieldPath, schema.required?.includes(key)));
    }
  });

  return wrapper;
}

function renderSection(schema, title, path) {
  const div = document.createElement("div");
  div.className = "card mb-3";

  const body = document.createElement("div");
  body.className = "card-body";

  const h = document.createElement("h5");
  h.className = "card-title";
  h.textContent = schema.title || title;
  body.appendChild(h);

  body.appendChild(renderObject(schema, path));
  div.appendChild(body);
  return div;
}

function renderArray(schema, key, path) {
  const div = document.createElement("div");
  div.className = "mb-3";

  const label = document.createElement("label");
  label.className = "form-label fw-bold";
  label.textContent = schema.title || key;
  div.appendChild(label);

  const list = document.createElement("div");
  div.appendChild(list);

  const addBtn = document.createElement("button");
  addBtn.type = "button";
  addBtn.className = "btn btn-outline-primary btn-sm mt-2";
  addBtn.textContent = "+ Ajouter";
  addBtn.onclick = () => {
    list.appendChild(renderArrayItem(schema.items, path));
  };

  div.appendChild(addBtn);
  return div;
}

function renderArrayItem(itemSchema, path) {
  const itemDiv = document.createElement("div");
  itemDiv.className = "border rounded p-3 mt-2";

  if (itemSchema.type === "object") {
    itemDiv.appendChild(renderObject(itemSchema, path));
  } else {
    itemDiv.appendChild(renderPrimitive(itemSchema, "", path));
  }

  const removeBtn = document.createElement("button");
  removeBtn.type = "button";
  removeBtn.className = "btn btn-sm btn-outline-danger mt-2";
  removeBtn.textContent = "Retirer";
  removeBtn.onclick = () => itemDiv.remove();

  itemDiv.appendChild(removeBtn);
  return itemDiv;
}

function renderPrimitive(schema, key, path, required=false) {
  const div = document.createElement("div");
  div.className = "mb-3";

  const label = document.createElement("label");
  label.className = "form-label";
  label.textContent = schema.title || key;
  div.appendChild(label);

  let input;

  if (schema.type === "boolean") {
    input = document.createElement("input");
    input.type = "checkbox";
    input.className = "form-check-input ms-2";
  } else {
    input = document.createElement("input");
    input.type = schema.type === "integer" || schema.type === "number" ? "number" : "text";
    input.className = "form-control";
  }

  input.dataset.path = path.join(".");
  if (required) input.required = true;

  if (schema.description)
    input.placeholder = schema.description;

  div.appendChild(input);
  return div;
}

async function handleSubmit(e) {
  e.preventDefault();
  const form = e.target;

  if (!form.checkValidity()) {
    form.classList.add("was-validated");
    return;
  }

  const data = collectData(window.RECIPE_SCHEMA, form);
  const yamlContent = jsyaml.dump(data, { indent: 2, lineWidth: -1 });

  const response = await fetch("/create-pr", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      yaml: yamlContent,
      nom_court: data.nom_court
    })
  });

  const result = await response.json();

  if (result.success) {
    alert("PR créée : " + result.pr_url);
    window.open(result.pr_url, "_blank");
  } else {
    alert("Erreur : " + result.error);
  }
}

function collectData(schema, container, path=[]) {

  if (schema.type === "object") {
    const obj = {};
    Object.entries(schema.properties).forEach(([key, prop]) => {
      obj[key] = collectData(prop, container, [...path, key]);
    });
    return obj;
  }

  if (schema.type === "array") {
    const items = [];
    container.querySelectorAll(`[data-path^="${path.join(".")}"]`).forEach(el => {
      if (el.value) items.push(el.value);
    });
    return items;
  }

  const selector = `[data-path="${path.join(".")}"]`;
  const input = container.querySelector(selector);

  if (!input) return null;

  if (schema.type === "boolean") return input.checked;
  if (schema.type === "integer") return parseInt(input.value) || null;
  if (schema.type === "number") return parseFloat(input.value) || null;

  return input.value || null;
}
</script>
