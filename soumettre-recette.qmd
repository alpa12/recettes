---
title: "Soumettre une recette"
format:
  html:
    toc: false
---

<!-- Syst√®me d'onglets -->
<ul class="nav nav-tabs mb-4" id="submissionTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button" role="tab" aria-controls="manual" aria-selected="true">
      üìù Formulaire manuel
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="url-tab" data-bs-toggle="tab" data-bs-target="#url" type="button" role="tab" aria-controls="url" aria-selected="false">
      üîó Importer depuis une URL
    </button>
  </li>
</ul>

<div class="tab-content" id="submissionTabsContent">
  <!-- Onglet 1: Formulaire manuel -->
  <div class="tab-pane fade show active" id="manual" role="tabpanel" aria-labelledby="manual-tab">
    <div id="recipe-form-container">
      <div class="alert alert-info" role="alert">
        Chargement du formulaire...
      </div>
    </div>
  </div>
  
  <!-- Onglet 2: Formulaire URL -->
  <div class="tab-pane fade" id="url" role="tabpanel" aria-labelledby="url-tab">
    <div class="alert alert-warning" role="alert">
      <h5>‚ö†Ô∏è Import automatique avec IA</h5>
      <p class="mb-0">Cette fonctionnalit√© utilise un LLM pour extraire automatiquement les informations de la recette depuis une URL. L'import sera valid√© manuellement avant publication.</p>
    </div>
    
    <form id="url-form" class="mb-4">
      <div class="mb-3">
        <label for="recipe-url" class="form-label required-field">URL de la recette</label>
        <input type="url" class="form-control" id="recipe-url" placeholder="https://exemple.com/ma-recette" required>
        <div class="form-text">Entrez l'URL compl√®te d'une recette sur un site web externe.</div>
      </div>
      
      <div class="mb-3">
        <label for="url-submitted-by" class="form-label">Votre nom (optionnel)</label>
        <input type="text" class="form-control" id="url-submitted-by" placeholder="Votre nom">
      </div>
      
      <div class="d-grid gap-2">
        <button type="submit" class="btn btn-primary btn-lg">Soumettre l'URL</button>
      </div>
    </form>
    
    <div id="url-success-message" class="alert alert-success d-none" role="alert">
      <h4 class="alert-heading">‚úÖ URL soumise avec succ√®s!</h4>
      <p>Une Pull Request a √©t√© cr√©√©e avec votre URL. L'import automatique sera effectu√© apr√®s validation manuelle.</p>
      <p class="mb-0">Vous pouvez la voir ici: <a id="url-pr-link" href="#" target="_blank" class="alert-link"></a></p>
    </div>
    
    <div id="url-error-message" class="alert alert-danger d-none" role="alert">
      <h4 class="alert-heading">‚ùå Erreur</h4>
      <p id="url-error-text"></p>
    </div>
  </div>
</div>

<!-- Messages pour le formulaire manuel -->
<div id="success-message" class="alert alert-success d-none" role="alert">
  <h4 class="alert-heading">‚úÖ Recette soumise avec succ√®s!</h4>
  <p>Votre recette a √©t√© soumise et une Pull Request a √©t√© cr√©√©e.</p>
  <p class="mb-0">Vous pouvez la voir ici: <a id="pr-link" href="#" target="_blank" class="alert-link"></a></p>
</div>

<div id="error-message" class="alert alert-danger d-none" role="alert">
  <h4 class="alert-heading">‚ùå Erreur</h4>
  <p id="error-text"></p>
</div>

<script src="config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>

<style>
.nav-tabs {
  border-bottom: 2px solid var(--bs-primary);
}

.nav-tabs .nav-link {
  border: none;
  color: var(--bs-secondary);
  padding: 0.75rem 1.5rem;
  font-weight: 500;
}

.nav-tabs .nav-link:hover {
  border: none;
  color: var(--bs-primary);
  background-color: var(--bs-light);
}

.nav-tabs .nav-link.active {
  color: var(--bs-primary);
  background-color: transparent;
  border: none;
  border-bottom: 3px solid var(--bs-primary);
}

.dynamic-array-item {
  background-color: var(--bs-light);
  padding: 1rem;
  margin-bottom: 1rem;
  border-radius: 0.375rem;
  border: 1px solid var(--bs-border-color);
}

.nested-section {
  background-color: var(--bs-body-bg);
  padding: 1.5rem;
  margin: 1rem 0;
  border-radius: 0.375rem;
  border: 2px solid var(--bs-primary);
}

.section-header {
  color: var(--bs-primary);
  border-bottom: 2px solid var(--bs-primary);
  padding-bottom: 0.5rem;
  margin-bottom: 1rem;
  font-weight: 600;
}

.btn-remove {
  float: right;
}

.ingredient-row, .equipement-row {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr auto;
  gap: 0.5rem;
  align-items: start;
  margin-bottom: 0.5rem;
}

.ingredient-row input, .equipement-row input {
  width: 100%;
}

#recipe-form .form-label {
  font-weight: 500;
  color: var(--bs-body-color);
}

.required-field::after {
  content: " *";
  color: var(--bs-danger);
}
</style>

<script>
// √âtat global pour stocker la structure du template
let templateStructure = null;
let formData = {};

// Charger et parser le template YAML
async function loadTemplate() {
  try {
    const response = await fetch('recettes/template.yaml');
    const yamlText = await response.text();
    templateStructure = jsyaml.load(yamlText);
    console.log('Template charg√©:', templateStructure);
    generateForm();
  } catch (error) {
    console.error('Erreur lors du chargement du template:', error);
    document.getElementById('recipe-form-container').innerHTML = 
      '<div class="alert alert-danger">Erreur lors du chargement du template.</div>';
  }
}

// G√©n√©rer le formulaire bas√© sur le template
function generateForm() {
  const container = document.getElementById('recipe-form-container');
  
  let html = '<form id="recipe-form" class="needs-validation" novalidate>';
  
  // Informations de base
  html += '<div class="mb-4">';
  html += '<h3 class="section-header">Informations de base</h3>';
  html += generateField('nom', 'text', 'Nom complet de la recette', true);
  html += generateField('nom_court', 'text', 'Nom court (pour table des mati√®res)', true);
  html += generateField('source', 'text', "D'o√π vient la recette", true);
  html += generateField('portions', 'number', 'Nombre de portions', true);
  html += generateField('se_congele', 'checkbox', 'Se cong√®le?', false);
  html += '</div>';
  
  // Cat√©gories
  html += '<div class="mb-4">';
  html += '<h3 class="section-header">Cat√©gories</h3>';
  html += '<div id="categories-container"></div>';
  html += '<button type="button" class="btn btn-sm btn-success" onclick="addCategory()">+ Ajouter une cat√©gorie</button>';
  html += '</div>';
  
  // Temps
  html += '<div class="mb-4">';
  html += '<h3 class="section-header">Temps</h3>';
  html += '<div class="row">';
  html += '<div class="col-md-4">' + generateField('temps.preparation', 'number', 'Pr√©paration (minutes)', false) + '</div>';
  html += '<div class="col-md-4">' + generateField('temps.cuisson', 'number', 'Cuisson (minutes)', false) + '</div>';
  html += '<div class="col-md-4">' + generateField('temps.refrigeration', 'number', 'R√©frig√©ration (minutes)', false) + '</div>';
  html += '</div>';
  html += '</div>';
  
  // Pr√©paration (sections avec √©tapes)
  html += '<div class="mb-4">';
  html += '<h3 class="section-header">Pr√©paration</h3>';
  html += '<div id="preparation-container"></div>';
  html += '<button type="button" class="btn btn-sm btn-success" onclick="addSection()">+ Ajouter une section</button>';
  html += '</div>';
  
  // Commentaires
  html += '<div class="mb-4">';
  html += '<h3 class="section-header">Commentaires</h3>';
  html += '<div id="commentaires-container"></div>';
  html += '<button type="button" class="btn btn-sm btn-success" onclick="addCommentaire()">+ Ajouter un commentaire</button>';
  html += '</div>';
  
  // Soumetteur
  html += '<div class="mb-4">';
  html += generateField('submitted_by', 'text', 'Votre nom (optionnel)', false);
  html += '</div>';
  
  // Bouton de soumission
  html += '<div class="d-grid gap-2">';
  html += '<button type="submit" class="btn btn-primary btn-lg">Soumettre la recette</button>';
  html += '</div>';
  
  html += '</form>';
  
  container.innerHTML = html;
  
  // Initialiser avec une cat√©gorie, une section, et un commentaire par d√©faut
  addCategory();
  addSection();
  addCommentaire();
  
  // Ajouter l'√©couteur de soumission
  document.getElementById('recipe-form').addEventListener('submit', handleSubmit);
}

// G√©n√©rer un champ de formulaire
function generateField(name, type, label, required = false) {
  const id = name.replace(/\./g, '-');
  const requiredClass = required ? 'required-field' : '';
  const requiredAttr = required ? 'required' : '';
  
  if (type === 'checkbox') {
    return `
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="${id}" name="${name}">
        <label class="form-check-label ${requiredClass}" for="${id}">
          ${label}
        </label>
      </div>
    `;
  }
  
  return `
    <div class="mb-3">
      <label for="${id}" class="form-label ${requiredClass}">${label}</label>
      <input type="${type}" class="form-control" id="${id}" name="${name}" ${requiredAttr}>
      <div class="invalid-feedback">Ce champ est requis.</div>
    </div>
  `;
}

// Fonctions pour g√©rer les cat√©gories
let categoryCount = 0;
function addCategory() {
  const container = document.getElementById('categories-container');
  const id = `category-${categoryCount++}`;
  const html = `
    <div class="input-group mb-2" id="${id}">
      <input type="text" class="form-control" placeholder="Ex: Poulet, Rapide, Biscuit..." name="category">
      <button class="btn btn-outline-danger" type="button" onclick="removeElement('${id}')">Retirer</button>
    </div>
  `;
  container.insertAdjacentHTML('beforeend', html);
}

// Fonctions pour g√©rer les sections de pr√©paration
let sectionCount = 0;
function addSection() {
  const container = document.getElementById('preparation-container');
  const sectionId = `section-${sectionCount++}`;
  const html = `
    <div class="nested-section" id="${sectionId}">
      <button type="button" class="btn btn-sm btn-danger btn-remove" onclick="removeElement('${sectionId}')">Retirer la section</button>
      <div class="mb-3">
        <label class="form-label required-field">Nom de la section</label>
        <input type="text" class="form-control" name="section-name" placeholder="Ex: P√¢te, Garniture, Sauce..." required>
      </div>
      <h5 class="mt-3 mb-2">√âtapes</h5>
      <div class="etapes-container" id="${sectionId}-etapes"></div>
      <button type="button" class="btn btn-sm btn-success" onclick="addEtape('${sectionId}')">+ Ajouter une √©tape</button>
    </div>
  `;
  container.insertAdjacentHTML('beforeend', html);
  addEtape(sectionId);
}

// Fonctions pour g√©rer les √©tapes
let etapeCount = 0;
function addEtape(sectionId) {
  const container = document.getElementById(`${sectionId}-etapes`);
  const etapeId = `etape-${etapeCount++}`;
  const html = `
    <div class="dynamic-array-item" id="${etapeId}">
      <button type="button" class="btn btn-sm btn-danger btn-remove" onclick="removeElement('${etapeId}')">Retirer l'√©tape</button>
      <div class="mb-3">
        <label class="form-label required-field">Description de l'√©tape</label>
        <textarea class="form-control" rows="2" name="etape-text" required></textarea>
      </div>
      
      <h6>Ingr√©dients</h6>
      <div class="ingredients-container" id="${etapeId}-ingredients"></div>
      <button type="button" class="btn btn-sm btn-outline-success btn-sm mb-3" onclick="addIngredient('${etapeId}')">+ Ajouter un ingr√©dient</button>
      
      <h6>√âquipements</h6>
      <div class="equipements-container" id="${etapeId}-equipements"></div>
      <button type="button" class="btn btn-sm btn-outline-success btn-sm" onclick="addEquipement('${etapeId}')">+ Ajouter un √©quipement</button>
    </div>
  `;
  container.insertAdjacentHTML('beforeend', html);
  addIngredient(etapeId);
  addEquipement(etapeId);
}

// Fonctions pour g√©rer les ingr√©dients
let ingredientCount = 0;
function addIngredient(etapeId) {
  const container = document.getElementById(`${etapeId}-ingredients`);
  const ingredientId = `ingredient-${ingredientCount++}`;
  const html = `
    <div class="ingredient-row" id="${ingredientId}">
      <input type="text" class="form-control form-control-sm" placeholder="Nom" name="ingredient-nom">
      <input type="number" class="form-control form-control-sm" placeholder="Qt√©" name="ingredient-qte" step="0.01">
      <input type="text" class="form-control form-control-sm" placeholder="Unit√©" name="ingredient-uni">
      <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeElement('${ingredientId}')">√ó</button>
    </div>
  `;
  container.insertAdjacentHTML('beforeend', html);
}

// Fonctions pour g√©rer les √©quipements
let equipementCount = 0;
function addEquipement(etapeId) {
  const container = document.getElementById(`${etapeId}-equipements`);
  const equipementId = `equipement-${equipementCount++}`;
  const html = `
    <div class="input-group input-group-sm mb-2" id="${equipementId}">
      <input type="text" class="form-control" placeholder="√âquipement" name="equipement-nom">
      <button class="btn btn-outline-danger" type="button" onclick="removeElement('${equipementId}')">√ó</button>
    </div>
  `;
  container.insertAdjacentHTML('beforeend', html);
}

// Fonctions pour g√©rer les commentaires
let commentaireCount = 0;
function addCommentaire() {
  const container = document.getElementById('commentaires-container');
  const id = `commentaire-${commentaireCount++}`;
  const html = `
    <div class="input-group mb-2" id="${id}">
      <input type="text" class="form-control" placeholder="Commentaire" name="commentaire">
      <button class="btn btn-outline-danger" type="button" onclick="removeElement('${id}')">Retirer</button>
    </div>
  `;
  container.insertAdjacentHTML('beforeend', html);
}

// Fonction g√©n√©rique pour retirer un √©l√©ment
function removeElement(id) {
  document.getElementById(id).remove();
}

// Collecter les donn√©es du formulaire et g√©n√©rer le YAML
function collectFormData() {
  const data = {
    nom: document.getElementById('nom').value,
    nom_court: document.getElementById('nom-court').value,
    source: document.getElementById('source').value,
    portions: parseInt(document.getElementById('portions').value),
    se_congele: document.getElementById('se-congele').checked,
    categories: [],
    temps: {
      preparation: parseInt(document.getElementById('temps-preparation').value) || null,
      cuisson: parseInt(document.getElementById('temps-cuisson').value) || null,
      refrigeration: parseInt(document.getElementById('temps-refrigeration').value) || null
    },
    preparation: [],
    commentaires: []
  };
  
  // Collecter les cat√©gories
  document.querySelectorAll('[name="category"]').forEach(input => {
    if (input.value.trim()) {
      data.categories.push(input.value.trim());
    }
  });
  
  // Collecter les sections de pr√©paration
  document.querySelectorAll('.nested-section').forEach(section => {
    const sectionData = {
      section: section.querySelector('[name="section-name"]').value,
      etapes: []
    };
    
    // Collecter les √©tapes de cette section
    section.querySelectorAll('.dynamic-array-item').forEach(etape => {
      const etapeData = {
        etape: etape.querySelector('[name="etape-text"]').value,
        ingredients: [],
        equipements: []
      };
      
      // Collecter les ingr√©dients
      etape.querySelectorAll('.ingredient-row').forEach(ing => {
        const nom = ing.querySelector('[name="ingredient-nom"]').value;
        const qte = ing.querySelector('[name="ingredient-qte"]').value;
        const uni = ing.querySelector('[name="ingredient-uni"]').value;
        if (nom) {
          etapeData.ingredients.push({
            nom: nom,
            qte: parseFloat(qte) || 1,
            uni: uni || 'unit√©'
          });
        }
      });
      
      // Collecter les √©quipements
      etape.querySelectorAll('[name="equipement-nom"]').forEach(eq => {
        if (eq.value.trim()) {
          etapeData.equipements.push(eq.value.trim());
        }
      });
      
      sectionData.etapes.push(etapeData);
    });
    
    data.preparation.push(sectionData);
  });
  
  // Collecter les commentaires
  document.querySelectorAll('[name="commentaire"]').forEach(input => {
    if (input.value.trim()) {
      data.commentaires.push(input.value.trim());
    }
  });
  
  // Ajouter submitted_by si fourni
  const submittedBy = document.getElementById('submitted-by').value;
  if (submittedBy.trim()) {
    data.submitted_by = submittedBy.trim();
  }
  
  return data;
}

// G√©rer la soumission du formulaire
async function handleSubmit(e) {
  e.preventDefault();
  
  const form = e.target;
  if (!form.checkValidity()) {
    e.stopPropagation();
    form.classList.add('was-validated');
    return;
  }
  
  try {
    const data = collectFormData();
    console.log('Donn√©es collect√©es:', data);
    
    // G√©n√©rer le contenu YAML
    const yamlContent = jsyaml.dump(data, {
      indent: 2,
      lineWidth: -1,
      noRefs: true
    });
    
    console.log('YAML g√©n√©r√©:', yamlContent);
    
    // Cr√©er le nom de fichier
    const filename = data.nom_court
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Retirer les accents
      .replace(/[^a-z0-9]+/g, '-') // Remplacer caract√®res sp√©ciaux par -
      .replace(/^-+|-+$/g, ''); // Retirer - au d√©but/fin
    
    // Cr√©er la PR via GitHub API
    await createPullRequest(data, yamlContent, filename);
    
  } catch (error) {
    console.error('Erreur:', error);
    showError(error.message);
  }
}

// Cr√©er une Pull Request sur GitHub
async function createPullRequest(data, yamlContent, filename) {
  const { token, owner, repo, baseBranch } = GITHUB_CONFIG;
  
  if (!token || !owner || !repo) {
    throw new Error('Configuration GitHub manquante.');
  }
  
  try {
    // D√©terminer la cat√©gorie (dossier)
    let folder = 'repas'; // Par d√©faut
    const categories = data.categories.map(c => c.toLowerCase());
    if (categories.some(c => c.includes('accompagnement'))) {
      folder = 'accompagnements';
    } else if (categories.some(c => c.includes('dessert') || c.includes('biscuit') || c.includes('g√¢teau'))) {
      folder = 'desserts';
    }
    
    const filepath = `recettes/${folder}/${filename}.yaml`;
    const branchName = `recipe-${filename}-${Date.now()}`;
    
    // Obtenir le SHA de la branche de base
    const refResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/refs/heads/${baseBranch}`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });
    
    if (!refResponse.ok) {
      const errorData = await refResponse.json();
      throw new Error(`Impossible de r√©cup√©rer la branche ${baseBranch}: ` + (errorData.message || 'Erreur inconnue'));
    }
    
    const refData = await refResponse.json();
    const baseSha = refData.object.sha;
    
    // Cr√©er une nouvelle branche
    await fetch(`https://api.github.com/repos/${owner}/${repo}/git/refs`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        ref: `refs/heads/${branchName}`,
        sha: baseSha
      })
    });
    
    // Cr√©er le fichier
    const createFileResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filepath}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: `Ajout de la recette: ${data.nom}`,
        content: btoa(unescape(encodeURIComponent(yamlContent))),
        branch: branchName
      })
    });
    
    if (!createFileResponse.ok) {
      const errorData = await createFileResponse.json();
      throw new Error('Impossible de cr√©er le fichier: ' + (errorData.message || 'Erreur inconnue'));
    }
    
    // Cr√©er la pull request
    const prResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/pulls`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        title: `Nouvelle recette: ${data.nom}`,
        body: `## Nouvelle recette soumise\n\n**Nom:** ${data.nom}\n**Source:** ${data.source}\n**Cat√©gories:** ${data.categories.join(', ')}\n**Portions:** ${data.portions}\n\n${data.submitted_by ? `**Soumis par:** ${data.submitted_by}\n\n` : ''}Recette ajout√©e via le formulaire de soumission.`,
        head: branchName,
        base: baseBranch
      })
    });
    
    if (!prResponse.ok) {
      const errorData = await prResponse.json();
      throw new Error('Impossible de cr√©er la pull request: ' + (errorData.message || 'Erreur inconnue'));
    }
    
    const prData = await prResponse.json();
    showSuccess(prData.html_url);
    
  } catch (error) {
    throw error;
  }
}

// Afficher le message de succ√®s
function showSuccess(prUrl) {
  document.getElementById('recipe-form').style.display = 'none';
  document.getElementById('success-message').classList.remove('d-none');
  document.getElementById('pr-link').href = prUrl;
  document.getElementById('pr-link').textContent = prUrl;
  window.scrollTo(0, 0);
}

// Afficher le message d'erreur
function showError(message) {
  document.getElementById('error-message').classList.remove('d-none');
  document.getElementById('error-text').textContent = message;
  window.scrollTo(0, 0);
  setTimeout(() => {
    document.getElementById('error-message').classList.add('d-none');
  }, 10000);
}

// G√©rer la soumission du formulaire URL
document.addEventListener('DOMContentLoaded', () => {
  loadTemplate();
  
  const urlForm = document.getElementById('url-form');
  if (urlForm) {
    urlForm.addEventListener('submit', handleUrlSubmit);
  }
});

async function handleUrlSubmit(e) {
  e.preventDefault();
  
  const form = e.target;
  if (!form.checkValidity()) {
    e.stopPropagation();
    form.classList.add('was-validated');
    return;
  }
  
  try {
    const url = document.getElementById('recipe-url').value;
    const submittedBy = document.getElementById('url-submitted-by').value;
    
    // Cr√©er le contenu du fichier pending
    const pendingContent = {
      url: url,
      submitted_at: new Date().toISOString(),
      status: 'pending'
    };
    
    if (submittedBy.trim()) {
      pendingContent.submitted_by = submittedBy.trim();
    }
    
    // Cr√©er le nom de fichier bas√© sur le timestamp
    const filename = `pending-${Date.now()}.yaml`;
    
    // Cr√©er la PR
    await createUrlPullRequest(pendingContent, filename, url);
    
  } catch (error) {
    console.error('Erreur:', error);
    showUrlError(error.message);
  }
}

async function createUrlPullRequest(pendingContent, filename, url) {
  const { token, owner, repo, baseBranch } = GITHUB_CONFIG;
  
  if (!token || !owner || !repo) {
    throw new Error('Configuration GitHub manquante.');
  }
  
  try {
    const yamlContent = jsyaml.dump(pendingContent, {
      indent: 2,
      lineWidth: -1,
      noRefs: true
    });
    
    const filepath = `recettes/pending/${filename}`;
    const branchName = `recipe-url-${Date.now()}`;
    
    // Obtenir le SHA de la branche de base
    const refResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/refs/heads/${baseBranch}`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });
    
    if (!refResponse.ok) {
      const errorData = await refResponse.json();
      throw new Error(`Impossible de r√©cup√©rer la branche ${baseBranch}: ` + (errorData.message || 'Erreur inconnue'));
    }
    
    const refData = await refResponse.json();
    const baseSha = refData.object.sha;
    
    // Cr√©er une nouvelle branche
    await fetch(`https://api.github.com/repos/${owner}/${repo}/git/refs`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        ref: `refs/heads/${branchName}`,
        sha: baseSha
      })
    });
    
    // Cr√©er le fichier pending
    const createFileResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filepath}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: `Import de recette depuis URL: ${url}`,
        content: btoa(unescape(encodeURIComponent(yamlContent))),
        branch: branchName
      })
    });
    
    if (!createFileResponse.ok) {
      const errorData = await createFileResponse.json();
      throw new Error('Impossible de cr√©er le fichier: ' + (errorData.message || 'Erreur inconnue'));
    }
    
    // Cr√©er la pull request
    const prBody = `## Import de recette depuis URL\n\n**URL:** ${url}\n${pendingContent.submitted_by ? `**Soumis par:** ${pendingContent.submitted_by}\n` : ''}\nCette recette n√©cessite un import automatique via LLM.\n\n---\n\n‚ö†Ô∏è Cette PR sera trait√©e automatiquement par le workflow d'import.`;
    
    const prResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/pulls`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        title: `Import recette: ${url}`,
        body: prBody,
        head: branchName,
        base: baseBranch
      })
    });
    
    if (!prResponse.ok) {
      const errorData = await prResponse.json();
      throw new Error('Impossible de cr√©er la pull request: ' + (errorData.message || 'Erreur inconnue'));
    }
    
    const prData = await prResponse.json();
    showUrlSuccess(prData.html_url);
    
  } catch (error) {
    throw error;
  }
}

function showUrlSuccess(prUrl) {
  document.getElementById('url-form').style.display = 'none';
  document.getElementById('url-success-message').classList.remove('d-none');
  document.getElementById('url-pr-link').href = prUrl;
  document.getElementById('url-pr-link').textContent = prUrl;
  window.scrollTo(0, 0);
}

function showUrlError(message) {
  document.getElementById('url-error-message').classList.remove('d-none');
  document.getElementById('url-error-text').textContent = message;
  window.scrollTo(0, 0);
  setTimeout(() => {
    document.getElementById('url-error-message').classList.add('d-none');
  }, 10000);
}
</script>
```
