name: Convert Recipe YAML to QMD

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'recettes/*.yaml'

jobs:
  convert-yaml-to-qmd:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        ref: ${{ github.head_ref }}
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.3.0'
    
    - name: Install R dependencies
      run: |
        install.packages(c("yaml", "fs", "stringr"), repos = "https://cloud.r-project.org/")
      shell: Rscript {0}
    
    - name: Source R conversion function
      run: |
        source("R/yaml_to_qmd.R")
      shell: Rscript {0}
    
    - name: Find and convert new/modified YAML files
      run: |
        # Get list of changed YAML files in recettes directory
        git fetch origin ${{ github.base_ref }}
        changed_files=$(git diff --name-only origin/${{ github.base_ref }} HEAD -- recettes/*.yaml || echo "")
        
        if [ -z "$changed_files" ]; then
          echo "No YAML files changed in recettes directory"
          exit 0
        fi
        
        echo "Changed YAML files:"
        echo "$changed_files"
        
        # Convert each changed YAML file
        for yaml_file in $changed_files; do
          if [ -f "$yaml_file" ]; then
            echo "Converting $yaml_file to QMD..."
            Rscript -e "source('R/yaml_to_qmd.R'); yaml_recipe_to_qmd('$yaml_file')"
          fi
        done
      shell: bash
    
    - name: Check if QMD files were generated
      id: check_qmd
      run: |
        if [ -n "$(git status --porcelain recettes/*.qmd)" ]; then
          echo "qmd_generated=true" >> $GITHUB_OUTPUT
        else
          echo "qmd_generated=false" >> $GITHUB_OUTPUT
        fi
      shell: bash
    
    - name: Commit and push QMD files
      if: steps.check_qmd.outputs.qmd_generated == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add recettes/*.qmd
        git commit -m "Auto-generate QMD files from YAML recipes"
        git push
      shell: bash
